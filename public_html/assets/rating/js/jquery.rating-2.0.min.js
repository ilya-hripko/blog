(function(b){b.rating=function(f,g){this.options=b.extend({fx:"float",image:"/images/stars.png",stars:5,minimal:0,titles:["vote","votes","votes"],readOnly:false,url:"",type:"post",loader:"/images/ajax-loader.gif",click:function(){},callback:function(){}},g||{});this.el=b(f);this.left=0;this.width=0;this.height=0;this._data={};var d=this;this.el.find(":hidden").each(function(){var e=b(this);d._data[e.attr("name")]=e.val()});this._data.val=parseFloat(this._data.val)||0;this._data.votes=parseFloat(this._data.votes)||"";if(this._data.val>this.options.stars){this._data.val=this.options.stars}if(this._data.val<0){this._data.val=0}this.old=this._data.val;this.vote_wrap=b('<div class="vote-wrap"></div>');this.vote_block=b('<div class="vote-block"></div>');this.vote_hover=b('<div class="vote-hover"></div>');this.vote_stars=b('<div class="vote-stars"></div>');this.vote_active=b('<div class="vote-active"></div>');this.vote_result=b('<div class="vote-result"></div>');this.vote_success=b('<div class="vote-success"></div>');this.loader=b('<img src="'+this.options.loader+'" alt="load...">');this.el.html(this.loader);var c=new Image();c.src=this.options.image;c.onload=function(){d.width=this.width;d.height=this.height/3;d.init()}};var a=b.rating;a.fn=a.prototype={rating:"2.0"};a.fn.extend=a.extend=b.extend;a.fn.extend({init:function(){this.render();if(this.options.readOnly){return}var c=this,e=0,d=0;this.vote_hover.bind("mousemove mouseover",function(i){if(c.options.readOnly){return}var h=b(this),j=0;e=i.clientX>0?i.clientX:i.pageX;d=e-h.offset().left-2;var f=c.width*c.options.stars,g=c.options.minimal*c.width;if(d>f){d=f}if(d<g){d=g}j=Math.round(d/c.width*10)/10;if(c.options.fx=="half"){d=Math.ceil(d/c.width*2)*c.width/2}else{if(c.options.fx!="float"){d=Math.ceil(d/c.width)*c.width}}j=Math.round(d/c.width*10)/10;c.vote_active.css({width:d,"background-position":"left center"});c.vote_success.html("Your vote: "+j)}).bind("mouseout",function(){if(c.options.readOnly){return}c.reset();c.vote_success.empty()}).bind("click.rating",function(){if(c.options.readOnly){return}var f=Math.round(d/c.width*10)/10;if(f>c.options.stars){f=c.options.stars}if(f<0){f=0}c.old=c._data.val;c._data.val=(c._data.val*c._data.votes+f)/(c._data.votes+1);c._data.val=Math.round(c._data.val*100)/100;c._data.score=f;c.vote_success.html("Your vote: "+f);if(c.options.url!=""){c.send()}c.options.readOnly=true;c.options.click.apply(this,[f])})},set:function(){this.vote_active.css({width:this._data.val*this.width,"background-position":"left bottom"})},reset:function(){this.vote_active.css({width:this.old*this.width,"background-position":"left bottom"})},setvoters:function(){this.vote_result.html(this.declOfNum(this._data.votes))},render:function(){this.el.html(this.vote_wrap.append(this.vote_hover.css({padding:"0 4px",height:this.height,width:this.width*this.options.stars}),this.vote_result.text(this.declOfNum(this._data.votes)),this.vote_success));this.vote_block.append(this.vote_stars.css({height:this.height,width:this.width*this.options.stars,background:"url('"+this.options.image+"') left top"}),this.vote_active.css({height:this.height,width:this._data.val*this.width,background:"url('"+this.options.image+"') left bottom"})).appendTo(this.vote_hover)},send:function(d){var c=this;this.vote_result.html(this.loader);this._data.votes++;b.ajax({url:c.options.url,type:c.options.type,data:this._data,dataType:"json",success:function(e){if(e.status=="OK"){c.set()}else{c._data.votes--;c.reset()}c.setvoters();if(e.msg){c.vote_success.html(e.msg)}if(typeof c.options.callback=="function"){c.options.callback.apply(c,[e])}}})},declOfNum:function(c){if(c<=0){return""}c=Math.abs(Math.floor(c));cases=[2,0,1,1,1,2];return c+" "+this.options.titles[(c%100>4&&c%100<20)?2:cases[(c%10<5)?c%10:5]]}});b.fn.rating=function(e){if(typeof e=="string"){var c=b(this).data("rating"),d=Array.prototype.slice.call(arguments,1);return c[e].apply(c,d)}else{return this.each(function(){var f=b(this).data("rating");if(f){if(e){b.extend(f.options,e)}f.init()}else{b(this).data("rating",new a(this,e))}})}}})(jQuery);